name: Daily YouTube Summary

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (í•œêµ­ì‹œê°„ ê¸°ì¤€, UTC+9)
    - cron: '0 0 * * *'  # UTC 00:00 = KST 09:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup YouTube credentials
      env:
        CLIENT_SECRET_BASE64: ${{ secrets.CLIENT_SECRET_BASE64 }}
        TOKEN_PICKLE_BASE64: ${{ secrets.TOKEN_PICKLE_BASE64 }}
        YOUTUBE_COOKIES: ${{ secrets.YOUTUBE_COOKIES }}
      run: |
        if [ -n "$CLIENT_SECRET_BASE64" ]; then
          echo "$CLIENT_SECRET_BASE64" | base64 --decode > client_secret.json
          echo "âœ… client_secret.json ìƒì„± ì™„ë£Œ"
        else
          echo "âš ï¸ CLIENT_SECRET_BASE64 secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
        fi
        
        if [ -n "$TOKEN_PICKLE_BASE64" ]; then
          echo "$TOKEN_PICKLE_BASE64" | base64 --decode > token.pickle
          echo "âœ… token.pickle ìƒì„± ì™„ë£Œ"
        else
          echo "âš ï¸ TOKEN_PICKLE_BASE64 secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
        fi
        
        if [ -n "$YOUTUBE_COOKIES" ]; then
          echo "$YOUTUBE_COOKIES" > youtube.com_cookies.txt
          echo "âœ… youtube.com_cookies.txt ìƒì„± ì™„ë£Œ"
        else
          echo "âš ï¸ YOUTUBE_COOKIES secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
        fi
    
    - name: Update config with API key
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        if [ -f "config/config.yaml" ]; then
          sed -i "s/\${ANTHROPIC_API_KEY}/$ANTHROPIC_API_KEY/" config/config.yaml
          echo "âœ… config.yaml API í‚¤ ì£¼ì… ì™„ë£Œ"
        else
          echo "âŒ config/config.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
    
    - name: Create required directories
      run: |
        mkdir -p data/audio
        mkdir -p data/transcripts
        mkdir -p data/summaries
        mkdir -p outputs
        echo "âœ… í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"
    
    - name: Run YouTube summary
      env:
        CI: true
      run: |
        echo "ğŸš€ YouTube ìš”ì•½ í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
        python main.py --max-videos 10
        echo "âœ… YouTube ìš”ì•½ ì™„ë£Œ"
    
    - name: Check output files
      run: |
        echo "ğŸ“Š ìƒì„±ëœ íŒŒì¼ ëª©ë¡:"
        ls -lah outputs/
        
        if [ -z "$(ls -A outputs/)" ]; then
          echo "âš ï¸ ì¶œë ¥ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          exit 1
        fi
    
    - name: Create index.html
      run: |
        cd outputs
        TODAY=$(date +%Y%m%d)
        
        if [ -f "${TODAY}_summary.html" ]; then
          cp "${TODAY}_summary.html" index.html
          echo "âœ… index.html ìƒì„± ì™„ë£Œ: ${TODAY}_summary.html"
        else
          echo "âš ï¸ ${TODAY}_summary.html íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          LATEST_HTML=$(ls -t *_summary.html 2>/dev/null | head -n 1)
          if [ -n "$LATEST_HTML" ]; then
            cp "$LATEST_HTML" index.html
            echo "âœ… index.html ìƒì„± ì™„ë£Œ: $LATEST_HTML"
          else
            echo "âŒ HTML íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: youtube-summary-${{ github.run_number }}
        path: |
          outputs/*.html
          outputs/*.md
          outputs/*.xlsx
          outputs/*.json
        retention-days: 30
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./outputs
        publish_branch: gh-pages
        keep_files: false
        commit_message: "ğŸš€ Update summary: ${{ github.run_number }}"

    - name: Summary
      if: success()
      run: |
        echo "================================================"
        echo "âœ… YouTube ì¢‹ì•„ìš” ìš”ì•½ ì™„ë£Œ!"
        echo "================================================"
        echo "ğŸ“Š ê²°ê³¼ í™•ì¸:"
        echo "   https://${{ github.repository_owner }}.github.io/youtube-likes-summary/"
        echo ""
        echo "ğŸ“¦ ë‹¤ìš´ë¡œë“œ:"
        echo "   Actions íƒ­ â†’ ì´ë²ˆ ì‹¤í–‰ â†’ Artifacts"
        echo "================================================"
