"""
YouTube ì˜ìƒ ìë§‰ ì¶”ì¶œ ëª¨ë“ˆ
"""
import os
import json
from youtube_transcript_api import YouTubeTranscriptApi
from youtube_transcript_api._errors import TranscriptsDisabled, NoTranscriptFound

class TranscriptExtractor:
    def __init__(self):
        self.transcript_dir = 'data/transcripts'
        os.makedirs(self.transcript_dir, exist_ok=True)
    
    def extract_transcript(self, video_id, languages=['ko', 'en']):
        """
        ì˜ìƒì˜ ìë§‰ ì¶”ì¶œ
        
        Args:
            video_id: YouTube ì˜ìƒ ID
            languages: ì„ í˜¸ ì–¸ì–´ ë¦¬ìŠ¤íŠ¸ (ìš°ì„ ìˆœìœ„ ìˆœ)
        
        Returns:
            dict: ìë§‰ í…ìŠ¤íŠ¸ì™€ ë©”íƒ€ë°ì´í„°
        """
        try:
            # ìë§‰ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            transcript_list = YouTubeTranscriptApi.list_transcripts(video_id)
            
            # ì„ í˜¸ ì–¸ì–´ ìˆœì„œëŒ€ë¡œ ì‹œë„
            transcript = None
            language_used = None
            
            for lang in languages:
                try:
                    transcript = transcript_list.find_transcript([lang])
                    language_used = lang
                    break
                except NoTranscriptFound:
                    continue
            
            # ì„ í˜¸ ì–¸ì–´ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±ëœ ìë§‰ ì°¾ê¸°
            if not transcript:
                try:
                    transcript = transcript_list.find_generated_transcript(['ko', 'en'])
                    language_used = transcript.language_code
                except:
                    # ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ìë§‰ ì‚¬ìš©
                    transcripts = list(transcript_list)
                    if transcripts:
                        transcript = transcripts[0]
                        language_used = transcript.language_code
            
            if transcript:
                # ìë§‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                transcript_data = transcript.fetch()
                
                # í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
                full_text = ' '.join([entry['text'] for entry in transcript_data])
                
                result = {
                    'video_id': video_id,
                    'language': language_used,
                    'is_generated': transcript.is_generated,
                    'text': full_text,
                    'entries': transcript_data,  # íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨ ì „ì²´ ë°ì´í„°
                    'status': 'success'
                }
                
                print(f"âœ… ìë§‰ ì¶”ì¶œ ì„±ê³µ: {video_id} (ì–¸ì–´: {language_used})")
                return result
            
        except TranscriptsDisabled:
            print(f"âš ï¸  ìë§‰ ë¹„í™œì„±í™”: {video_id}")
            return {
                'video_id': video_id,
                'status': 'disabled',
                'error': 'ìë§‰ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤'
            }
        
        except Exception as e:
            print(f"âŒ ìë§‰ ì¶”ì¶œ ì‹¤íŒ¨: {video_id} - {str(e)}")
            return {
                'video_id': video_id,
                'status': 'error',
                'error': str(e)
            }
    
    def extract_multiple(self, videos):
        """
        ì—¬ëŸ¬ ì˜ìƒì˜ ìë§‰ ì¼ê´„ ì¶”ì¶œ
        
        Args:
            videos: ì˜ìƒ ì •ë³´ ë¦¬ìŠ¤íŠ¸
        
        Returns:
            list: ì¶”ì¶œëœ ìë§‰ ë¦¬ìŠ¤íŠ¸
        """
        results = []
        
        for i, video in enumerate(videos, 1):
            video_id = video['video_id']
            print(f"[{i}/{len(videos)}] ìë§‰ ì¶”ì¶œ ì¤‘: {video['title'][:50]}...")
            
            transcript = self.extract_transcript(video_id)
            
            # ì˜ìƒ ë©”íƒ€ë°ì´í„° ì¶”ê°€
            transcript['video_title'] = video['title']
            transcript['video_url'] = video['url']
            transcript['channel'] = video['channel']
            
            results.append(transcript)
        
        print(f"\nâœ… ì´ {len(results)}ê°œ ì˜ìƒ ìë§‰ ì¶”ì¶œ ì™„ë£Œ")
        return results
    
    def save_transcripts(self, transcripts):
        """ì¶”ì¶œí•œ ìë§‰ë“¤ì„ ê°œë³„ íŒŒì¼ë¡œ ì €ì¥"""
        for transcript in transcripts:
            if transcript['status'] == 'success':
                video_id = transcript['video_id']
                filepath = os.path.join(self.transcript_dir, f"{video_id}.json")
                
                with open(filepath, 'w', encoding='utf-8') as f:
                    json.dump(transcript, f, ensure_ascii=False, indent=2)
        
        print(f"âœ… ìë§‰ íŒŒì¼ ì €ì¥ ì™„ë£Œ: {self.transcript_dir}")
    
    def load_transcript(self, video_id):
        """ì €ì¥ëœ ìë§‰ ë¡œë“œ"""
        filepath = os.path.join(self.transcript_dir, f"{video_id}.json")
        
        if not os.path.exists(filepath):
            return None
        
        with open(filepath, 'r', encoding='utf-8') as f:
            return json.load(f)
    
    def is_english_content(self, transcript):
        """ì˜ì–´ í•™ìŠµ ì½˜í…ì¸ ì¸ì§€ íŒë‹¨"""
        if not transcript or transcript.get('status') != 'success':
            return False
        
        # ìë§‰ ì–¸ì–´ê°€ ì˜ì–´ì´ê±°ë‚˜
        if transcript.get('language') in ['en', 'en-US', 'en-GB']:
            return True
        
        # ì œëª©ì— ì˜ì–´ í•™ìŠµ ê´€ë ¨ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´
        title = transcript.get('video_title', '').lower()
        english_keywords = ['english', 'ì˜ì–´', 'toeic', 'speaking', 'grammar', 'vocabulary']
        
        return any(keyword in title for keyword in english_keywords)


if __name__ == "__main__":
    import json
    
    # í…ŒìŠ¤íŠ¸ìš©: likes_raw.jsonì—ì„œ ì˜ìƒ ë¡œë“œ
    with open('data/likes_raw.json', 'r', encoding='utf-8') as f:
        videos = json.load(f)
    
    # ìë§‰ ì¶”ì¶œ
    extractor = TranscriptExtractor()
    transcripts = extractor.extract_multiple(videos[:5])  # ì²˜ìŒ 5ê°œë§Œ í…ŒìŠ¤íŠ¸
    extractor.save_transcripts(transcripts)
    
    # ì˜ì–´ ì½˜í…ì¸  í™•ì¸
    for t in transcripts:
        if extractor.is_english_content(t):
            print(f"ğŸ“š ì˜ì–´ í•™ìŠµ ì½˜í…ì¸ : {t['video_title']}")