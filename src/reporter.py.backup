"""
ìš”ì•½ ë¦¬í¬íŠ¸ ìƒì„± ëª¨ë“ˆ (Markdown, Excel)
"""
import os
import json
from datetime import datetime, timedelta
import pandas as pd

class ReportGenerator:
    def __init__(self):
        self.output_dir = 'outputs'
        os.makedirs(self.output_dir, exist_ok=True)
    
    def generate_markdown_report(self, summaries, categorized_videos, filename=None):
        """Markdown í˜•ì‹ ì¼ì¼ ìš”ì•½ ë¦¬í¬íŠ¸ ìƒì„±"""
        if not filename:
            filename = f"{datetime.now().strftime('%Y%m%d')}_summary.md"
        
        filepath = os.path.join(self.output_dir, filename)
        
        with open(filepath, 'w', encoding='utf-8') as f:
            # í—¤ë”
            f.write(f"# YouTube ì¢‹ì•„ìš” ì˜ìƒ ìš”ì•½\n\n")
            f.write(f"**ìƒì„±ì¼ì‹œ**: {datetime.now().strftime('%Yë…„ %mì›” %dì¼ %H:%M')}\n\n")
            f.write(f"**ì´ ì˜ìƒ ìˆ˜**: {len(summaries)}ê°œ\n\n")
            
            # ì¹´í…Œê³ ë¦¬ë³„ í†µê³„
            f.write("## ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬\n\n")
            for category, videos in sorted(categorized_videos.items()):
                f.write(f"- **{category}**: {len(videos)}ê°œ\n")
            f.write("\n---\n\n")
            
            # ì„±ê³µí•œ ìš”ì•½ì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ ì¶œë ¥
            success_summaries = [s for s in summaries if s.get('status') == 'success']
            
            if not success_summaries:
                f.write("## âš ï¸ ì•Œë¦¼\n\n")
                f.write("ìë§‰ì„ ì¶”ì¶œí•  ìˆ˜ ìˆëŠ” ì˜ìƒì´ ì—†ì—ˆìŠµë‹ˆë‹¤.\n")
                f.write("- ì¼ë¶€ ì˜ìƒì€ ìë§‰ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆê±°ë‚˜ ìë§‰ì´ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n")
                f.write("- ìë§‰ì´ ìˆëŠ” ì˜ìƒì„ ì¢‹ì•„ìš”ì— ì¶”ê°€í•˜ì‹œë©´ ë‹¤ìŒ ì‹¤í–‰ ì‹œ ìš”ì•½ë©ë‹ˆë‹¤.\n\n")
            else:
                # ì¹´í…Œê³ ë¦¬ë³„ ìš”ì•½
                for category in sorted(categorized_videos.keys()):
                    f.write(f"## ğŸ“ {category}\n\n")
                    
                    category_summaries = [
                        s for s in summaries 
                        if s['status'] == 'success' and 
                        any(v['video_id'] == s['video_id'] for v in categorized_videos[category])
                    ]
                    
                    for i, summary in enumerate(category_summaries, 1):
                        f.write(f"### {i}. {summary['video_title']}\n\n")
                        f.write(f"**ì±„ë„**: {summary['channel']}  \n")
                        f.write(f"**ë§í¬**: [{summary['video_url']}]({summary['video_url']})  \n")
                        f.write(f"**ìœ í˜•**: {'ì˜ì–´í•™ìŠµ' if summary['type'] == 'english_learning' else 'ì¼ë°˜'}\n\n")
                        f.write(f"{summary['summary']}\n\n")
                        f.write("---\n\n")
                
                # ì˜ì–´ í•™ìŠµ ì˜ìƒ ë³„ë„ ì„¹ì…˜
                english_summaries = [s for s in summaries if s.get('type') == 'english_learning' and s['status'] == 'success']
                
                if english_summaries:
                    f.write("## ğŸ“š ì˜ì–´ í•™ìŠµ ì½˜í…ì¸  (ë³µìŠµìš©)\n\n")
                    f.write("*ë°˜ë³µ í•™ìŠµì„ ìœ„í•´ ì˜ì–´ í•™ìŠµ ì½˜í…ì¸ ë¥¼ ë³„ë„ë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.*\n\n")
                    
                    for i, summary in enumerate(english_summaries, 1):
                        f.write(f"### {i}. {summary['video_title']}\n\n")
                        f.write(f"[ì˜ìƒ ë³´ê¸°]({summary['video_url']})\n\n")
                        f.write(f"{summary['summary']}\n\n")
                        f.write("---\n\n")
        
        print(f"âœ… Markdown ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: {filepath}")
        return filepath
    
    def generate_excel_report(self, summaries, categorized_videos, filename=None):
        """Excel í˜•ì‹ í•™ìŠµ ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±"""
        if not filename:
            filename = f"{datetime.now().strftime('%Y%m%d')}_youtube_summaries.xlsx"
        
        filepath = os.path.join(self.output_dir, filename)
        
        # ì„±ê³µí•œ ìš”ì•½ë§Œ í•„í„°ë§
        success_summaries = [s for s in summaries if s.get('status') == 'success']
        
        if not success_summaries:
            print("âš ï¸  ìš”ì•½ëœ ì˜ìƒì´ ì—†ì–´ Excel íŒŒì¼ì„ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return None
        
        # ë°ì´í„° ì¤€ë¹„
        data = []
        
        # ì¹´í…Œê³ ë¦¬ ì •ë³´ ë§¤í•‘
        video_categories = {}
        for category, videos in categorized_videos.items():
            for video in videos:
                video_categories[video['video_id']] = category
        
        for summary in success_summaries:
            data.append({
                'ì¹´í…Œê³ ë¦¬': video_categories.get(summary['video_id'], 'ê¸°íƒ€'),
                'ì œëª©': summary['video_title'],
                'ì±„ë„': summary['channel'],
                'URL': summary['video_url'],
                'ìœ í˜•': 'ì˜ì–´í•™ìŠµ' if summary['type'] == 'english_learning' else 'ì¼ë°˜',
                'ìš”ì•½': summary['summary'],
                'ìˆ˜ì§‘ì¼ì‹œ': datetime.now().strftime('%Y-%m-%d %H:%M')
            })
        
        # DataFrame ìƒì„±
        df = pd.DataFrame(data)
        
        # Excel ì €ì¥
        with pd.ExcelWriter(filepath, engine='openpyxl') as writer:
            # ì „ì²´ ì‹œíŠ¸
            df.to_excel(writer, sheet_name='ì „ì²´', index=False)
            
            # ì¹´í…Œê³ ë¦¬ë³„ ì‹œíŠ¸
            for category in df['ì¹´í…Œê³ ë¦¬'].unique():
                category_df = df[df['ì¹´í…Œê³ ë¦¬'] == category]
                sheet_name = category[:31]  # Excel ì‹œíŠ¸ëª… ê¸¸ì´ ì œí•œ
                category_df.to_excel(writer, sheet_name=sheet_name, index=False)
            
            # ì˜ì–´ í•™ìŠµ ì „ìš© ì‹œíŠ¸
            english_df = df[df['ìœ í˜•'] == 'ì˜ì–´í•™ìŠµ']
            if not english_df.empty:
                english_df.to_excel(writer, sheet_name='ì˜ì–´í•™ìŠµ_ë³µìŠµìš©', index=False)
        
        print(f"âœ… Excel ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: {filepath}")
        return filepath
    
    def generate_review_schedule(self, summaries, days=[1, 3, 7, 14, 30]):
        """ë³µìŠµ ì¼ì • ìƒì„± (ê°„ê²© ë°˜ë³µ í•™ìŠµ)"""
        
        schedule = {}
        today = datetime.now()
        
        english_summaries = [s for s in summaries if s.get('type') == 'english_learning' and s['status'] == 'success']
        
        if not english_summaries:
            print("âš ï¸  ì˜ì–´ í•™ìŠµ ì½˜í…ì¸ ê°€ ì—†ì–´ ë³µìŠµ ì¼ì •ì„ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return {}
        
        for day in days:
            review_date = (today + timedelta(days=day)).strftime('%Y-%m-%d')
            schedule[review_date] = [
                {
                    'title': s['video_title'],
                    'url': s['video_url'],
                    'day': f"D+{day}"
                }
                for s in english_summaries
            ]
        
        # ë³µìŠµ ì¼ì •ì„ Markdownìœ¼ë¡œ ì €ì¥
        schedule_file = os.path.join(self.output_dir, 'review_schedule.md')
        
        with open(schedule_file, 'w', encoding='utf-8') as f:
            f.write("# ğŸ“… ì˜ì–´ í•™ìŠµ ë³µìŠµ ì¼ì •\n\n")
            f.write("*ê°„ê²© ë°˜ë³µ í•™ìŠµì„ ìœ„í•œ ë³µìŠµ ìŠ¤ì¼€ì¤„ì…ë‹ˆë‹¤.*\n\n")
            
            for date in sorted(schedule.keys()):
                videos = schedule[date]
                f.write(f"## {date} ({videos[0]['day']})\n\n")
                
                for video in videos:
                    f.write(f"- [ ] [{video['title']}]({video['url']})\n")
                
                f.write("\n")
        
        print(f"âœ… ë³µìŠµ ì¼ì • ìƒì„± ì™„ë£Œ: {schedule_file}")
        return schedule
    
    def generate_statistics(self, summaries, categorized_videos):
        """í†µê³„ ì •ë³´ ìƒì„±"""
        stats = {
            'ì´_ì˜ìƒ_ìˆ˜': len(summaries),
            'ì„±ê³µ_ìš”ì•½_ìˆ˜': len([s for s in summaries if s.get('status') == 'success']),
            'ì˜ì–´í•™ìŠµ_ì½˜í…ì¸ ': len([s for s in summaries if s.get('type') == 'english_learning']),
            'ì¹´í…Œê³ ë¦¬ë³„_ë¶„í¬': {cat: len(vids) for cat, vids in categorized_videos.items()},
            'ìƒì„±ì¼ì‹œ': datetime.now().isoformat()
        }
        
        stats_file = os.path.join(self.output_dir, 'statistics.json')
        with open(stats_file, 'w', encoding='utf-8') as f:
            json.dump(stats, f, ensure_ascii=False, indent=2)
        
        print(f"âœ… í†µê³„ ì •ë³´ ì €ì¥: {stats_file}")
        return stats